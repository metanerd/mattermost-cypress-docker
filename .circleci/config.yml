version: 2.1
orbs:
  node: circleci/node@1.1.6
jobs:
  build-and-test:
    docker:
      - image: cypress/browsers:node10.16.3-chrome80-ff73
      - image: postgres:9.4
        environment:
          POSTGRES_USER: mmuser
          POSTGRES_PASSWORD: mostest
          POSTGRES_DB: mattermost_test
      - image: jhillyerd/inbucket:release-1.2.0
      - image: osixia/openldap:1.2.2
        environment:
          LDAP_TLS_VERIFY_CLIENT: "never"
          LDAP_ORGANISATION: "Mattermost Test"
          LDAP_DOMAIN: "mm.test.com"
          LDAP_ADMIN_PASSWORD: "mostest"
      - image: minio/minio:RELEASE.2019-10-11T00-38-09Z
        environment:
          MINIO_ACCESS_KEY: minioaccesskey
          MINIO_SECRET_KEY: miniosecretkey
          MINIO_SSE_MASTER_KEY: "my-minio-key:6368616e676520746869732070617373776f726420746f206120736563726574"
      - image: mattermost/mattermost-elasticsearch-docker:6.5.1
        environment:
          http.host: "0.0.0.0"
          http.port: 9200
          http.cors.enabled: "true"
          http.cors.allow-origin: "http://localhost:1358,http://127.0.0.1:1358"
          http.cors.allow-headers: "X-Requested-With,X-Auth-Token,Content-Type,Content-Length,Authorization"
          http.cors.allow-credentials: "true"
          transport.host: "127.0.0.1"
          ES_JAVA_OPTS: "-Xms512m -Xmx512m"
    working_directory: ~/mattermost-cypress-docker
    environment:
      COMPOSE_PROJECT_NAME: "circleci"
    steps:
      - setup_remote_docker
      - checkout
      - attach_workspace:
          at: ~/mattermost-cypress-docker
      - run:
          name: Checks
          command: |
            pwd
            ls -rtl
            which docker
            docker --version
            which docker-compose
            docker-compose --version
      # - run:
      #     name: Install Docker client
      #     command: apk add docker-cli
      # - run:
      #     name: Install Docker Compose
      #     command: |
      #       set -x
      #       curl -L https://github.com/docker/compose/releases/download/1.25.3/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
      #       chmod +x /usr/local/bin/docker-compose
      - run:
          name: Build Docker compose
          command: |
            make build
          background: true
      - run:
          name: Run server
          command: |
            make run
          background: true
      - run:
          name: Run cypress test
          command: |
            docker run --net mattermost-e2e_mm-test --rm --name mattermost-e2e_cypress -e CYPRESS_baseUrl=http://app:8000 -e CYPRESS_webhookBaseUrl=http://webhook:3000 mattermost-e2e/cypress
          background: true
workflows:
    build-and-test:
      jobs:
        - build-and-test
